"use strict";var NodyAjax={send:function(){},post:function(e,t,a,s){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(n.status>=200&&n.status<300||304===n.status?(s(n.responseText),console.log(n.responseText)):console.log("postMessage: unsuccessful post. status code "+n.status))},n.open("post",a,!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8");var o={message:e,user:t,date:new Date};n.send(JSON.stringify(o))},get:function(e,t){function a(e,t,a){console.log("createStream: inside createStream");var s=new XMLHttpRequest,n=0;return s.open("get",e,!0),s.onreadystatechange=function(){console.log("createStream: inside onreadyStateChange");var e=null;3===s.readyState?(console.log("createStream: readyState 3"),e=s.responseText.substring(n),n+=e.length,t(e)):4===s.readyState&&(console.log("createStream: readyState 4"),a(s.responseText))},s.send(null),s}console.log("createStream: inside get"),a("/messages",e,t)},allMessages:function(e,t){var a=1,s=4,n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState===a&&console.log("allMessages: opened"),n.readyState===s&&(n.status>=200&&n.status<300||304==n.status?(console.log(n.responseText),t(n.responseText)):console.log("Error. XHR status "+n.status))},n.open("get",e,!0),n.send(null)},experiment:function(e,t){function a(e,t,a){console.log("createStream: inside createStream");var s=new XMLHttpRequest,n=0;return s.open("get",e,!0),s.onreadystatechange=function(){console.log("createStream: inside onreadyStateChange");var e=null;3===s.readyState?(console.log("createStream: readyState 3"),e=s.responseText.substring(n),n+=e.length,t(e)):4===s.readyState&&(console.log("createStream: readyState 4"),a(s.responseText))},s.send(null),s}console.log("createStream: inside get"),a("/experiment",e,t)}},MessageBoard={helpers:{checkObject:function(e,t){return Object.prototype.toString.call(e)===t},isString:function(e){return MessageBoard.helpers.checkObject(e,"[object String]")},Message:function(e,t,a){if(a=a||new Date,MessageBoard.helpers.isString(e)&&MessageBoard.helpers.isString(t))return{message:e,user:t,date:a};throw new Error("Message: failed to create new Message.")},insertMessage:function(e,t,a){var s=new MessageBoard.helpers.Message(e,t,a),n=document.createElement("div"),o=document.createElement("p");o.textContent="by "+s.user;var r=document.createElement("strong");r.appendChild(o);var c=document.createElement("p");c.textContent=s.date,c.setAttribute("class","small");var l=document.createElement("small");l.appendChild(r),l.appendChild(c);var d=document.createElement("blockquote");if(d.textContent=s.message,d.appendChild(l),n.appendChild(d),messageboard.hasChildNodes()){var u=messageboard.firstChild;messageboard.insertBefore(d,u)}else messageboard.appendChild(n)}},dataTransport:{xhrStream:function(e,t){NodyAjax.get(e,t)},SSE:function(){console.log("SSE enabled browser.");var e=new EventSource("/stream");e.onmessage=function(e){console.log("PING! SSE event!"),MessageBoard.parseMessage(e.data)}}},parseMessage:function(e){if(e instanceof Array)e.forEach(function(e){var t=e.message,a=e.user,s=e.date;MessageBoard.helpers.insertMessage(t,a,s)});else{var t=e;"string"==typeof t&&(t=JSON.parse(e)),MessageBoard.helpers.insertMessage(t.message,t.user,t.date)}},handleDOM:function(){var e=document.querySelector("#submitButton"),t=document.querySelector("#chatbox"),a=document.body,s=(document.querySelector("#messageboard"),document.querySelector("#userEmail").textContent);a.addEventListener("keydown",function(e){if(e=e||event,e.target===t&&13===e.keyCode){if(!t.value)return void e.preventDefault();t.value.replace(/\n/g,"<br>"),NodyAjax.post(t.value,s,"/messages",MessageBoard.parseMessage),e.preventDefault(),t.value=""}},!1),a.addEventListener("click",function(a){a=a||event,a.target===e&&(a.preventDefault(),NodyAjax.post(t.value,s,"/messages",MessageBoard.parseMessage),t.value="")})},init:function(){if(MessageBoard.handleDOM(),window.EventSource){var e=function(e){JSON.parse(e).forEach(function(e){MessageBoard.parseMessage(e)})},t=function(){MessageBoard.dataTransport.xhrStream(e,t)},a=function(a){MessageBoard.dataTransport.xhrStream(e,t),JSON.parse(a).forEach(function(e){MessageBoard.parseMessage(e)})};NodyAjax.allMessages("/allmessages",a),NodyAjax.experiment()}else MessageBoard.dataTransport.SSE()}};window.onload=MessageBoard.init;var NodyAjax={send:function(){},post:function(e,t,a,s){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(n.status>=200&&n.status<300||304===n.status?(s(n.responseText),console.log(n.responseText)):console.log("postMessage: unsuccessful post. status code "+n.status))},n.open("post",a,!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8");var o={message:e,user:t,date:new Date};n.send(JSON.stringify(o))},get:function(e,t){function a(e,t,a){console.log("createStream: inside createStream");var s=new XMLHttpRequest,n=0;return s.open("get",e,!0),s.onreadystatechange=function(){console.log("createStream: inside onreadyStateChange");var e=null;3===s.readyState?(console.log("createStream: readyState 3"),e=s.responseText.substring(n),n+=e.length,t(e)):4===s.readyState&&(console.log("createStream: readyState 4"),a(s.responseText))},s.send(null),s}console.log("createStream: inside get"),a("/messages",e,t)},allMessages:function(e,t){var a=1,s=4,n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState===a&&console.log("allMessages: opened"),n.readyState===s&&(n.status>=200&&n.status<300||304==n.status?(console.log(n.responseText),t(n.responseText)):console.log("Error. XHR status "+n.status))},n.open("get",e,!0),n.send(null)},experiment:function(e,t){function a(e,t,a){console.log("createStream: inside createStream");var s=new XMLHttpRequest,n=0;return s.open("get",e,!0),s.onreadystatechange=function(){console.log("createStream: inside onreadyStateChange");var e=null;3===s.readyState?(console.log("createStream: readyState 3"),e=s.responseText.substring(n),n+=e.length,t(e)):4===s.readyState&&(console.log("createStream: readyState 4"),a(s.responseText))},s.send(null),s}console.log("createStream: inside get"),a("/experiment",e,t)}};